{% extends "base.html" %}

{% block title %}{{ item.sku }}{% endblock %}
{% block mobile_title %}{{ item.sku }}{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">
    <div class="page-header">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{{ url_for('inventory.item_list') }}">Inventory</a></li>
                    <li class="breadcrumb-item active">{{ item.sku }}</li>
                </ol>
            </nav>
            <h1>{{ item.name }}</h1>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('labels.quick_label', item_id=item.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-upc"></i> Print Label
            </a>
            <a href="{{ url_for('inventory.item_edit', item_id=item.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            {% if current_user.is_admin() %}
            <form method="POST" action="{{ url_for('inventory.item_delete', item_id=item.id) }}" class="d-inline"
                  onsubmit="return confirm('Delete {{ item.sku }}?\n\n{% if item.total_stock > 0 %}WARNING: This item has {{ item.total_stock }} in stock. All stock will be removed.{% else %}This cannot be undone.{% endif %}')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Overview -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <div class="fs-4 fw-bold {% if item.is_low_stock %}text-danger{% endif %}">{{ item.total_stock }}</div>
                                <small class="text-muted">Total Stock ({{ item.unit_of_measure }})</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <div class="fs-4 fw-bold">{{ item.available_stock }}</div>
                                <small class="text-muted">Available</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <div class="fs-4 fw-bold">&pound;{{ "{:,.2f}".format(item.unit_cost or 0) }}</div>
                                <small class="text-muted">Unit Cost</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <div class="fs-4 fw-bold">&pound;{{ "{:,.2f}".format(item.total_stock * (item.unit_cost or 0)) }}</div>
                                <small class="text-muted">Stock Value</small>
                            </div>
                        </div>
                    </div>

                    {% if item.is_low_stock %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Stock is below reorder point ({{ item.reorder_point }})
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Stock by Location -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Stock by Location</span>
                    <div>
                        <a href="{{ url_for('inventory.receive_stock') }}?item_id={{ item.id }}" class="btn btn-sm btn-success me-1">
                            <i class="bi bi-box-arrow-in-down"></i> Receive
                        </a>
                        <a href="{{ url_for('inventory.move_stock') }}?item_id={{ item.id }}" class="btn btn-sm btn-info">
                            <i class="bi bi-arrows-move"></i> Move
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if stock_levels %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th class="text-end">Quantity</th>
                                    <th class="text-end">Allocated</th>
                                    <th class="text-end">Available</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sl in stock_levels %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('locations.location_detail', location_id=sl.location.id) }}">
                                            <strong>{{ sl.location.code }}</strong>
                                        </a>
                                        <br><small class="text-muted">{{ sl.location.name }}</small>
                                    </td>
                                    <td class="text-end">{{ sl.quantity }}</td>
                                    <td class="text-end">{{ sl.allocated_quantity }}</td>
                                    <td class="text-end">{{ sl.available_quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state py-4">
                        <i class="bi bi-inbox"></i>
                        <p>No stock on hand</p>
                        <a href="{{ url_for('inventory.receive_stock') }}?item_id={{ item.id }}" class="btn btn-success">Receive Stock</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Movements -->
            <div class="card mb-3">
                <div class="card-header">Recent Movements</div>
                <div class="card-body p-0">
                    {% if recent_movements %}
                    <div class="list-group list-group-flush">
                        {% for m in recent_movements %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <span>
                                    <span class="badge bg-{{ 'success' if m.movement_type == 'receipt' else 'info' if m.movement_type == 'movement' else 'warning' if m.movement_type == 'production' else 'secondary' }}">
                                        {{ m.movement_type|title }}
                                    </span>
                                    {{ m.quantity }} {{ item.unit_of_measure }}
                                    {% if m.from_location %}from {{ m.from_location.code }}{% endif %}
                                    {% if m.to_location %}to {{ m.to_location.code }}{% endif %}
                                </span>
                                <small class="text-muted">{{ m.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            </div>
                            {% if m.notes %}<small class="text-muted">{{ m.notes }}</small>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state py-4">
                        <p>No movement history</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Details -->
            <div class="card mb-3">
                <div class="card-header">Details</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>SKU</th>
                            <td>{{ item.sku }}</td>
                        </tr>
                        <tr>
                            <th>Barcode</th>
                            <td>{{ item.barcode or item.sku }}</td>
                        </tr>
                        <tr>
                            <th>Type</th>
                            <td>{{ item.item_type|replace('_', ' ')|title if item.item_type else '-' }}</td>
                        </tr>
                        <tr>
                            <th>Customer</th>
                            <td>
                                {% if item.customer %}
                                <a href="{{ url_for('customers.customer_detail', customer_id=item.customer.id) }}">{{ item.customer.name }}</a>
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Category</th>
                            <td>{{ item.category.name if item.category else '-' }}</td>
                        </tr>
                        <tr>
                            <th>Unit</th>
                            <td>{{ item.unit_of_measure }}</td>
                        </tr>
                        {% if item.color %}
                        <tr>
                            <th>Color</th>
                            <td>{{ item.color }}</td>
                        </tr>
                        {% endif %}
                        {% if item.material_grade %}
                        <tr>
                            <th>Material</th>
                            <td>{{ item.material_grade }}</td>
                        </tr>
                        {% endif %}
                        {% if item.supplier %}
                        <tr>
                            <th>Supplier</th>
                            <td>{{ item.supplier }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Barcode -->
            <div class="card mb-3">
                <div class="card-header">Barcode</div>
                <div class="card-body text-center">
                    <div id="barcodeContainer" class="mb-2">
                        <div class="spinner-border spinner-border-sm text-muted" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <small class="text-muted">{{ item.barcode or item.sku }}</small>
                </div>
            </div>

            <!-- Stock Settings -->
            <div class="card mb-3">
                <div class="card-header">Stock Settings</div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th>Min Level</th>
                            <td>{{ item.min_stock_level }}</td>
                        </tr>
                        <tr>
                            <th>Reorder Point</th>
                            <td>{{ item.reorder_point or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Reorder Qty</th>
                            <td>{{ item.reorder_quantity or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Default Location</th>
                            <td>{{ item.default_location.code if item.default_location else '-' }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            {% if item.image_filename %}
            <div class="card mb-3">
                <div class="card-header">Image</div>
                <div class="card-body p-0">
                    <img src="{{ url_for('static', filename='uploads/' + item.image_filename) }}" class="img-fluid rounded-bottom" alt="{{ item.name }}">
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load barcode image
fetch('/labels/api/barcode/{{ item.id }}')
    .then(r => r.json())
    .then(data => {
        const container = document.getElementById('barcodeContainer');
        if (data.data_url) {
            container.innerHTML = `<img src="${data.data_url}" class="img-fluid" alt="Barcode" style="max-height: 80px;">`;
        } else {
            container.innerHTML = '<p class="text-muted mb-0">Barcode unavailable</p>';
        }
    })
    .catch(() => {
        document.getElementById('barcodeContainer').innerHTML = '<p class="text-muted mb-0">Barcode unavailable</p>';
    });
</script>
{% endblock %}
