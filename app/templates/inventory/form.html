{% extends "base.html" %}

{% block title %}{{ 'Edit' if item else 'New' }} Item{% endblock %}
{% block mobile_title %}{{ 'Edit' if item else 'New' }} Item{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">
    <div class="page-header">
        <h1>{{ 'Edit Item' if item else 'New Item' }}</h1>
        {% if not item %}
        <div class="btn-group" role="group">
            <a href="{{ url_for('inventory.item_create', mode='simple') }}" class="btn btn-{{ 'primary' if mode == 'simple' else 'outline-primary' }}">
                <i class="bi bi-lightning me-1"></i>Simple
            </a>
            <a href="{{ url_for('inventory.item_create', mode='advanced') }}" class="btn btn-{{ 'primary' if mode == 'advanced' else 'outline-primary' }}">
                <i class="bi bi-sliders me-1"></i>Advanced
            </a>
        </div>
        {% endif %}
    </div>

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="mode" value="{{ mode }}">

        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Info -->
                <div class="card mb-3">
                    <div class="card-header">Basic Information</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">SKU *</label>
                                <input type="text" class="form-control" name="sku" value="{{ item.sku if item else '' }}" {{ 'readonly' if item else 'required' }} style="text-transform: uppercase;">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" name="name" value="{{ item.name if item else '' }}" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="2">{{ item.description if item else '' }}</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Customer</label>
                                <select class="form-select" name="customer_id">
                                    <option value="">No customer (general stock)</option>
                                    {% for cust in customers %}
                                    <option value="{{ cust.id }}" {% if item and item.customer_id == cust.id %}selected{% endif %}>{{ cust.name }}{% if cust.customer_code %} ({{ cust.customer_code }}){% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category_id">
                                    <option value="">Select category...</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}" {% if item and item.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Item Type</label>
                                <select class="form-select" name="item_type">
                                    <option value="">Select type...</option>
                                    <option value="raw_material" {% if item and item.item_type == 'raw_material' %}selected{% endif %}>Raw Material</option>
                                    <option value="masterbatch" {% if item and item.item_type == 'masterbatch' %}selected{% endif %}>Masterbatch</option>
                                    <option value="finished_goods" {% if item and item.item_type == 'finished_goods' %}selected{% endif %}>Finished Goods</option>
                                    <option value="regrind" {% if item and item.item_type == 'regrind' %}selected{% endif %}>Regrind</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" name="color" value="{{ item.color if item else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Unit of Measure</label>
                                <select class="form-select" name="unit_of_measure">
                                    <option value="parts" {% if not item or item.unit_of_measure == 'parts' %}selected{% endif %}>Parts</option>
                                    <option value="kg" {% if item and item.unit_of_measure == 'kg' %}selected{% endif %}>Kg</option>
                                    <option value="box" {% if item and item.unit_of_measure == 'box' %}selected{% endif %}>Box</option>
                                    <option value="pallet" {% if item and item.unit_of_measure == 'pallet' %}selected{% endif %}>Pallet</option>
                                    <option value="bag" {% if item and item.unit_of_measure == 'bag' %}selected{% endif %}>Bag</option>
                                    <option value="each" {% if item and item.unit_of_measure == 'each' %}selected{% endif %}>Each</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                {% if mode == 'advanced' or item %}
                <!-- Physical Properties (Advanced only) -->
                <div class="card mb-3">
                    <div class="card-header">Physical Properties</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" name="weight_kg" step="0.001" value="{{ item.weight_kg if item and item.weight_kg else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Length (mm)</label>
                                <input type="number" class="form-control" name="length_mm" step="0.1" value="{{ item.length_mm if item and item.length_mm else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Width (mm)</label>
                                <input type="number" class="form-control" name="width_mm" step="0.1" value="{{ item.width_mm if item and item.width_mm else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Height (mm)</label>
                                <input type="number" class="form-control" name="height_mm" step="0.1" value="{{ item.height_mm if item and item.height_mm else '' }}">
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Stock Settings -->
                <div class="card mb-3">
                    <div class="card-header">Stock Settings</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Default Location</label>
                                <select class="form-select" name="default_location_id">
                                    <option value="">Select location...</option>
                                    {% for loc in locations %}
                                    <option value="{{ loc.id }}" {% if item and item.default_location_id == loc.id %}selected{% endif %}>{{ loc.code }} - {{ loc.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% if mode == 'advanced' or item %}
                            <div class="col-12">
                                <hr>
                                <small class="text-muted">Leave these blank if you don't need low stock alerts</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Minimum Stock Level</label>
                                <input type="number" class="form-control" name="min_stock_level" step="1" min="0" value="{{ item.min_stock_level if item and item.min_stock_level else '' }}" placeholder="Optional">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Reorder Point</label>
                                <input type="number" class="form-control" name="reorder_point" step="1" min="0" value="{{ item.reorder_point if item and item.reorder_point else '' }}" placeholder="Optional">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Reorder Quantity</label>
                                <input type="number" class="form-control" name="reorder_quantity" step="1" min="0" value="{{ item.reorder_quantity if item and item.reorder_quantity else '' }}" placeholder="Optional">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if mode == 'advanced' or item %}
                <!-- Production & Moulding -->
                <div class="card mb-3">
                    <div class="card-header bg-info bg-opacity-10">
                        <i class="bi bi-gear me-2"></i>Production & Moulding
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Default Mould</label>
                                <select class="form-select" name="default_mould_id">
                                    <option value="">Select mould...</option>
                                    {% for mould in moulds %}
                                    <option value="{{ mould.id }}" {% if item and item.default_mould_id == mould.id %}selected{% endif %}>
                                        {{ mould.mould_number }} - {{ mould.name or 'Unnamed' }} ({{ mould.num_cavities }} cav)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cavities</label>
                                <input type="number" class="form-control" name="cavities" min="1" value="{{ item.cavities if item and item.cavities else 1 }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cycle Time (sec)</label>
                                <input type="number" class="form-control" name="cycle_time_seconds" step="0.1" value="{{ item.cycle_time_seconds if item and item.cycle_time_seconds else '' }}" placeholder="e.g. 30">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Part Weight (g)</label>
                                <input type="number" class="form-control" name="part_weight_grams" step="0.01" value="{{ item.part_weight_grams if item and item.part_weight_grams else '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Runner Weight (g)</label>
                                <input type="number" class="form-control" name="runner_weight_grams" step="0.01" value="{{ item.runner_weight_grams if item and item.runner_weight_grams else '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Setup Time (hrs)</label>
                                <input type="number" class="form-control" name="setup_time_hours" step="0.5" value="{{ item.setup_time_hours if item and item.setup_time_hours else 2 }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material & Costing -->
                <div class="card mb-3">
                    <div class="card-header bg-success bg-opacity-10">
                        <i class="bi bi-currency-pound me-2"></i>Material & Costing
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Material Type</label>
                                <select class="form-select" name="material_type">
                                    <option value="">Select...</option>
                                    {% for mt in ['PP', 'ABS', 'PA6', 'PA66', 'POM', 'PC', 'HDPE', 'PET', 'LDPE', 'PS', 'TPE'] %}
                                    <option value="{{ mt }}" {% if item and item.material_type == mt %}selected{% endif %}>{{ mt }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Material Grade</label>
                                <input type="text" class="form-control" name="material_grade" value="{{ item.material_grade if item else '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Material Cost (&pound;/kg)</label>
                                <input type="number" class="form-control" name="material_cost_per_kg" step="0.01" value="{{ item.material_cost_per_kg if item and item.material_cost_per_kg else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Linked Material</label>
                                <select class="form-select" name="material_id">
                                    <option value="">None</option>
                                    {% for mat in materials %}
                                    <option value="{{ mat.id }}" {% if item and item.material_id == mat.id %}selected{% endif %}>
                                        {{ mat.code }} - {{ mat.name }} (&pound;{{ "%.2f"|format(mat.cost_per_kg) }}/kg)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Masterbatch</label>
                                <select class="form-select" name="masterbatch_id">
                                    <option value="">None</option>
                                    {% for mb in masterbatch_materials %}
                                    <option value="{{ mb.id }}" {% if item and item.masterbatch_id == mb.id %}selected{% endif %}>
                                        {{ mb.code }} - {{ mb.name }} (&pound;{{ "%.2f"|format(mb.cost_per_kg) }}/kg)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Masterbatch Ratio (%)</label>
                                <input type="text" class="form-control" name="masterbatch_ratio" value="{{ item.masterbatch_ratio if item else '' }}" placeholder="e.g. 3%">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Regrind %</label>
                                <input type="number" class="form-control" name="regrind_percent" step="1" min="0" max="100"
                                       value="{{ item.regrind_percent|int if item and item.regrind_percent else 0 }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Machine Rate (&pound;/hr)</label>
                                <input type="number" class="form-control" name="target_machine_rate" step="1" value="{{ item.target_machine_rate if item and item.target_machine_rate else '' }}" placeholder="e.g. 45">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Target Margin %</label>
                                <input type="number" class="form-control" name="target_margin_percent" step="1" value="{{ item.target_margin_percent if item and item.target_margin_percent else 30 }}">
                            </div>
                        </div>

                        {% if item and (item.calculated_material_cost_per_part or item.calculated_cycle_cost_per_part) %}
                        <hr>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="text-muted small">Material/Part</div>
                                <div class="fs-5">&pound;{{ "%.4f"|format(item.calculated_material_cost_per_part or 0) }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small">Cycle/Part</div>
                                <div class="fs-5">&pound;{{ "%.4f"|format(item.calculated_cycle_cost_per_part or 0) }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small">Total Cost</div>
                                <div class="fs-5 fw-bold">&pound;{{ "%.4f"|format(item.calculated_total_cost_per_part or 0) }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small">Suggested Price</div>
                                <div class="fs-5 text-success fw-bold">&pound;{{ "%.4f"|format(item.calculated_selling_price or 0) }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="col-lg-4">
                <!-- Pricing -->
                <div class="card mb-3">
                    <div class="card-header">Pricing</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Unit Cost (&pound;)</label>
                            <input type="number" class="form-control" name="unit_cost" step="0.01" value="{{ item.unit_cost if item else 0 }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Selling Price (&pound;)</label>
                            <input type="number" class="form-control" name="selling_price" step="0.01" value="{{ item.selling_price if item else 0 }}">
                        </div>
                    </div>
                </div>

                <!-- Image -->
                <div class="card mb-3">
                    <div class="card-header">Image</div>
                    <div class="card-body">
                        {% if item and item.image_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + item.image_filename) }}" class="img-fluid rounded mb-3" alt="Product image">
                        {% endif %}
                        <input type="file" class="form-control" name="image" accept="image/*">
                    </div>
                </div>

                {% if mode == 'simple' and not item %}
                <div class="card mb-3 border-info">
                    <div class="card-body text-center">
                        <i class="bi bi-info-circle text-info fs-4 d-block mb-2"></i>
                        <p class="small text-muted mb-0">
                            Need to set mould details, material specs, or costing?
                            <a href="{{ url_for('inventory.item_create', mode='advanced') }}">Switch to Advanced mode</a>
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="d-flex justify-content-between mb-4">
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-lg me-1"></i> {{ 'Update' if item else 'Create' }} Item
                </button>
                <a href="{{ url_for('inventory.item_list') }}" class="btn btn-outline-secondary btn-lg">Cancel</a>
            </div>
            {% if item and current_user.is_admin() %}
            <form method="POST" action="{{ url_for('inventory.item_delete', item_id=item.id) }}" class="d-inline"
                  onsubmit="return confirm('DELETE item {{ item.sku }}?\n\n{% if item.total_stock > 0 %}This item has {{ item.total_stock|int }} in stock. Stock will be zeroed.{% endif %}\n\nThis cannot be undone!')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i> Delete Item
                </button>
            </form>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}
